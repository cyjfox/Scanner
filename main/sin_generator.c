#include "sin_generator.h"
#include "esp_check.h"
#include "driver/dac_common.h"
#include "math.h"
#include "esp_rom_sys.h"
#include "driver/timer.h"

//double[256] amplitude = 0.000000000, 0.003921569, 0.007843137, 0.011764706, 0.015686275, 0.019607843, 0.023529412, 0.027450980, 0.031372549, 0.035294118, 0.039215686, 0.043137255, 0.047058824, 0.050980392, 0.054901961, 0.058823529, 0.062745098, 0.066666667, 0.070588235, 0.074509804, 0.078431373, 0.082352941, 0.086274510, 0.090196078, 0.094117647, 0.098039216, 0.101960784, 0.105882353, 0.109803922, 0.113725490, 0.117647059, 0.121568627, 0.125490196, 0.129411765, 0.133333333, 0.137254902, 0.141176471, 0.145098039, 0.149019608, 0.152941176, 0.156862745, 0.160784314, 0.164705882, 0.168627451, 0.172549020, 0.176470588, 0.180392157, 0.184313725, 0.188235294, 0.192156863, 0.196078431, 0.200000000, 0.203921569, 0.207843137, 0.211764706, 0.215686275, 0.219607843, 0.223529412, 0.227450980, 0.231372549, 0.235294118, 0.239215686, 0.243137255, 0.247058824, 0.250980392, 0.254901961, 0.258823529, 0.262745098, 0.266666667, 0.270588235, 0.274509804, 0.278431373, 0.282352941, 0.286274510, 0.290196078, 0.294117647, 0.298039216, 0.301960784, 0.305882353, 0.309803922, 0.313725490, 0.317647059, 0.321568627, 0.325490196, 0.329411765, 0.333333333, 0.337254902, 0.341176471, 0.345098039, 0.349019608, 0.352941176, 0.356862745, 0.360784314, 0.364705882, 0.368627451, 0.372549020, 0.376470588, 0.380392157, 0.384313725, 0.388235294, 0.392156863, 0.396078431, 0.400000000, 0.403921569, 0.407843137, 0.411764706, 0.415686275, 0.419607843, 0.423529412, 0.427450980, 0.431372549, 0.435294118, 0.439215686, 0.443137255, 0.447058824, 0.450980392, 0.454901961, 0.458823529, 0.462745098, 0.466666667, 0.470588235, 0.474509804, 0.478431373, 0.482352941, 0.486274510, 0.490196078, 0.494117647, 0.498039216, 0.501960784, 0.505882353, 0.509803922, 0.513725490, 0.517647059, 0.521568627, 0.525490196, 0.529411765, 0.533333333, 0.537254902, 0.541176471, 0.545098039, 0.549019608, 0.552941176, 0.556862745, 0.560784314, 0.564705882, 0.568627451, 0.572549020, 0.576470588, 0.580392157, 0.584313725, 0.588235294, 0.592156863, 0.596078431, 0.600000000, 0.603921569, 0.607843137, 0.611764706, 0.615686275, 0.619607843, 0.623529412, 0.627450980, 0.631372549, 0.635294118, 0.639215686, 0.643137255, 0.647058824, 0.650980392, 0.654901961, 0.658823529, 0.662745098, 0.666666667, 0.670588235, 0.674509804, 0.678431373, 0.682352941, 0.686274510, 0.690196078, 0.694117647, 0.698039216, 0.701960784, 0.705882353, 0.709803922, 0.713725490, 0.717647059, 0.721568627, 0.725490196, 0.729411765, 0.733333333, 0.737254902, 0.741176471, 0.745098039, 0.749019608, 0.752941176, 0.756862745, 0.760784314, 0.764705882, 0.768627451, 0.772549020, 0.776470588, 0.780392157, 0.784313725, 0.788235294, 0.792156863, 0.796078431, 0.800000000, 0.803921569, 0.807843137, 0.811764706, 0.815686275, 0.819607843, 0.823529412, 0.827450980, 0.831372549, 0.835294118, 0.839215686, 0.843137255, 0.847058824, 0.850980392, 0.854901961, 0.858823529, 0.862745098, 0.866666667, 0.870588235, 0.874509804, 0.878431373, 0.882352941, 0.886274510, 0.890196078, 0.894117647, 0.898039216, 0.901960784, 0.905882353, 0.909803922, 0.913725490, 0.917647059, 0.921568627, 0.925490196, 0.929411765, 0.933333333, 0.937254902, 0.941176471, 0.945098039, 0.949019608, 0.952941176, 0.956862745, 0.960784314, 0.964705882, 0.968627451, 0.972549020, 0.976470588, 0.980392157, 0.984313725, 0.988235294, 0.992156863, 0.996078431, 1.000000000;

//double[256] t = 0.000000000, 0.000624139, 0.001248287, 0.001872454, 0.002496651, 0.003120885, 0.003745168, 0.004369508, 0.004993916, 0.005618400, 0.006242971, 0.006867638, 0.007492411, 0.008117300, 0.008742314, 0.009367463, 0.009992757, 0.010618205, 0.011243817, 0.011869604, 0.012495574, 0.013121738, 0.013748106, 0.014374687, 0.015001492, 0.015628530, 0.016255812, 0.016883347, 0.017511146, 0.018139219, 0.018767575, 0.019396225, 0.020025180, 0.020654449, 0.021284044, 0.021913973, 0.022544248, 0.023174879, 0.023805877, 0.024437252, 0.025069015, 0.025701176, 0.026333747, 0.026966738, 0.027600160, 0.028234024, 0.028868341, 0.029503121, 0.030138377, 0.030774120, 0.031410360, 0.032047108, 0.032684378, 0.033322179, 0.033960524, 0.034599424, 0.035238891, 0.035878937, 0.036519574, 0.037160814, 0.037802668, 0.038445150, 0.039088272, 0.039732046, 0.040376484, 0.041021600, 0.041667406, 0.042313914, 0.042961139, 0.043609092, 0.044257788, 0.044907240, 0.045557461, 0.046208465, 0.046860265, 0.047512875, 0.048166311, 0.048820585, 0.049475712, 0.050131706, 0.050788583, 0.051446357, 0.052105043, 0.052764656, 0.053425211, 0.054086724, 0.054749211, 0.055412687, 0.056077168, 0.056742671, 0.057409212, 0.058076808, 0.058745476, 0.059415231, 0.060086093, 0.060758078, 0.061431204, 0.062105489, 0.062780950, 0.063457608, 0.064135479, 0.064814583, 0.065494940, 0.066176569, 0.066859489, 0.067543720, 0.068229283, 0.068916199, 0.069604487, 0.070294171, 0.070985270, 0.071677807, 0.072371804, 0.073067284, 0.073764270, 0.074462784, 0.075162851, 0.075864495, 0.076567739, 0.077272609, 0.077979130, 0.078687328, 0.079397229, 0.080108859, 0.080822246, 0.081537417, 0.082254399, 0.082973223, 0.083693915, 0.084416507, 0.085141028, 0.085867508, 0.086595980, 0.087326475, 0.088059025, 0.088793663, 0.089530424, 0.090269341, 0.091010451, 0.091753788, 0.092499389, 0.093247291, 0.093997534, 0.094750155, 0.095505194, 0.096262692, 0.097022691, 0.097785232, 0.098550360, 0.099318118, 0.100088553, 0.100861710, 0.101637637, 0.102416382, 0.103197996, 0.103982529, 0.104770034, 0.105560564, 0.106354174, 0.107150921, 0.107950861, 0.108754054, 0.109560561, 0.110370445, 0.111183768, 0.112000597, 0.112821000, 0.113645046, 0.114472806, 0.115304353, 0.116139764, 0.116979115, 0.117822487, 0.118669962, 0.119521625, 0.120377563, 0.121237867, 0.122102630, 0.122971947, 0.123845918, 0.124724645, 0.125608234, 0.126496793, 0.127390437, 0.128289282, 0.129193449, 0.130103063, 0.131018255, 0.131939159, 0.132865915, 0.133798668, 0.134737568, 0.135682772, 0.136634443, 0.137592750, 0.138557870, 0.139529985, 0.140509288, 0.141495978, 0.142490264, 0.143492363, 0.144502504, 0.145520925, 0.146547876, 0.147583618, 0.148628426, 0.149682589, 0.150746411, 0.151820210, 0.152904324, 0.153999106, 0.155104932, 0.156222198, 0.157351323, 0.158492751, 0.159646956, 0.160814437, 0.161995730, 0.163191404, 0.164402068, 0.165628372, 0.166871014, 0.168130745, 0.169408372, 0.170704766, 0.172020870, 0.173357704, 0.174716379, 0.176098106, 0.177504211, 0.178936146, 0.180395513, 0.181884081, 0.183403815, 0.184956907, 0.186545813, 0.188173302, 0.189842513, 0.191557028, 0.193320967, 0.195139103, 0.197017026, 0.198961342, 0.200979960, 0.203082478, 0.205280739, 0.207589638, 0.210028354, 0.212622299, 0.215406387, 0.218430897, 0.221773022, 0.225562748, 0.230053610, 0.235900391, 0.250000000;
static const char *TAG = "sin generator";
const double time_per_tick = 0.000000025;
//double amp[256] = {-1.000000000, -0.992187500, -0.984375000, -0.976562500, -0.968750000, -0.960937500, -0.953125000, -0.945312500, -0.937500000, -0.929687500, -0.921875000, -0.914062500, -0.906250000, -0.898437500, -0.890625000, -0.882812500, -0.875000000, -0.867187500, -0.859375000, -0.851562500, -0.843750000, -0.835937500, -0.828125000, -0.820312500, -0.812500000, -0.804687500, -0.796875000, -0.789062500, -0.781250000, -0.773437500, -0.765625000, -0.757812500, -0.750000000, -0.742187500, -0.734375000, -0.726562500, -0.718750000, -0.710937500, -0.703125000, -0.695312500, -0.687500000, -0.679687500, -0.671875000, -0.664062500, -0.656250000, -0.648437500, -0.640625000, -0.632812500, -0.625000000, -0.617187500, -0.609375000, -0.601562500, -0.593750000, -0.585937500, -0.578125000, -0.570312500, -0.562500000, -0.554687500, -0.546875000, -0.539062500, -0.531250000, -0.523437500, -0.515625000, -0.507812500, -0.500000000, -0.492187500, -0.484375000, -0.476562500, -0.468750000, -0.460937500, -0.453125000, -0.445312500, -0.437500000, -0.429687500, -0.421875000, -0.414062500, -0.406250000, -0.398437500, -0.390625000, -0.382812500, -0.375000000, -0.367187500, -0.359375000, -0.351562500, -0.343750000, -0.335937500, -0.328125000, -0.320312500, -0.312500000, -0.304687500, -0.296875000, -0.289062500, -0.281250000, -0.273437500, -0.265625000, -0.257812500, -0.250000000, -0.242187500, -0.234375000, -0.226562500, -0.218750000, -0.210937500, -0.203125000, -0.195312500, -0.187500000, -0.179687500, -0.171875000, -0.164062500, -0.156250000, -0.148437500, -0.140625000, -0.132812500, -0.125000000, -0.117187500, -0.109375000, -0.101562500, -0.093750000, -0.085937500, -0.078125000, -0.070312500, -0.062500000, -0.054687500, -0.046875000, -0.039062500, -0.031250000, -0.023437500, -0.015625000, -0.007812500, 0.000000000, 0.007812500, 0.015625000, 0.023437500, 0.031250000, 0.039062500, 0.046875000, 0.054687500, 0.062500000, 0.070312500, 0.078125000, 0.085937500, 0.093750000, 0.101562500, 0.109375000, 0.117187500, 0.125000000, 0.132812500, 0.140625000, 0.148437500, 0.156250000, 0.164062500, 0.171875000, 0.179687500, 0.187500000, 0.195312500, 0.203125000, 0.210937500, 0.218750000, 0.226562500, 0.234375000, 0.242187500, 0.250000000, 0.257812500, 0.265625000, 0.273437500, 0.281250000, 0.289062500, 0.296875000, 0.304687500, 0.312500000, 0.320312500, 0.328125000, 0.335937500, 0.343750000, 0.351562500, 0.359375000, 0.367187500, 0.375000000, 0.382812500, 0.390625000, 0.398437500, 0.406250000, 0.414062500, 0.421875000, 0.429687500, 0.437500000, 0.445312500, 0.453125000, 0.460937500, 0.468750000, 0.476562500, 0.484375000, 0.492187500, 0.500000000, 0.507812500, 0.515625000, 0.523437500, 0.531250000, 0.539062500, 0.546875000, 0.554687500, 0.562500000, 0.570312500, 0.578125000, 0.585937500, 0.593750000, 0.601562500, 0.609375000, 0.617187500, 0.625000000, 0.632812500, 0.640625000, 0.648437500, 0.656250000, 0.664062500, 0.671875000, 0.679687500, 0.687500000, 0.695312500, 0.703125000, 0.710937500, 0.718750000, 0.726562500, 0.734375000, 0.742187500, 0.750000000, 0.757812500, 0.765625000, 0.773437500, 0.781250000, 0.789062500, 0.796875000, 0.804687500, 0.812500000, 0.820312500, 0.828125000, 0.835937500, 0.843750000, 0.851562500, 0.859375000, 0.867187500, 0.875000000, 0.882812500, 0.890625000, 0.898437500, 0.906250000, 0.914062500, 0.921875000, 0.929687500, 0.937500000, 0.945312500, 0.953125000, 0.960937500, 0.968750000, 0.976562500, 0.984375000, 0.992187500};
//double t[256] = {-0.250000000, -0.230092657, -0.221828352, -0.215474286, -0.210106912, -0.205368745, -0.201076558, -0.197121574, -0.193432959, -0.189961540, -0.186671533, -0.183535940, -0.180533797, -0.177648438, -0.174866360, -0.172176437, -0.169569377, -0.167037321, -0.164573556, -0.162172290, -0.159828486, -0.157537732, -0.155296137, -0.153100246, -0.150946979, -0.148833573, -0.146757540, -0.144716630, -0.142708798, -0.140732180, -0.138785075, -0.136865918, -0.134973272, -0.133105811, -0.131262308, -0.129441625, -0.127642706, -0.125864567, -0.124106289, -0.122367013, -0.120645935, -0.118942300, -0.117255399, -0.115584564, -0.113929166, -0.112288609, -0.110662333, -0.109049805, -0.107450521, -0.105864001, -0.104289792, -0.102727460, -0.101176593, -0.099636799, -0.098107703, -0.096588945, -0.095080184, -0.093581092, -0.092091355, -0.090610672, -0.089138753, -0.087675322, -0.086220111, -0.084772864, -0.083333333, -0.081901281, -0.080476478, -0.079058703, -0.077647741, -0.076243387, -0.074845439, -0.073453706, -0.072067999, -0.070688138, -0.069313947, -0.067945254, -0.066581895, -0.065223709, -0.063870540, -0.062522235, -0.061178647, -0.059839632, -0.058505049, -0.057174762, -0.055848638, -0.054526547, -0.053208361, -0.051893957, -0.050583214, -0.049276012, -0.047972235, -0.046671771, -0.045374508, -0.044080336, -0.042789149, -0.041500842, -0.040215312, -0.038932457, -0.037652178, -0.036374377, -0.035098959, -0.033825827, -0.032554890, -0.031286054, -0.030019230, -0.028754328, -0.027491260, -0.026229938, -0.024970276, -0.023712190, -0.022455594, -0.021200406, -0.019946544, -0.018693925, -0.017442468, -0.016192092, -0.014942719, -0.013694269, -0.012446663, -0.011199823, -0.009953671, -0.008708130, -0.007463123, -0.006218572, -0.004974402, -0.003730536, -0.002486897, -0.001243411, 0.000000000, 0.001243411, 0.002486897, 0.003730536, 0.004974402, 0.006218572, 0.007463123, 0.008708130, 0.009953671, 0.011199823, 0.012446663, 0.013694269, 0.014942719, 0.016192092, 0.017442468, 0.018693925, 0.019946544, 0.021200406, 0.022455594, 0.023712190, 0.024970276, 0.026229938, 0.027491260, 0.028754328, 0.030019230, 0.031286054, 0.032554890, 0.033825827, 0.035098959, 0.036374377, 0.037652178, 0.038932457, 0.040215312, 0.041500842, 0.042789149, 0.044080336, 0.045374508, 0.046671771, 0.047972235, 0.049276012, 0.050583214, 0.051893957, 0.053208361, 0.054526547, 0.055848638, 0.057174762, 0.058505049, 0.059839632, 0.061178647, 0.062522235, 0.063870540, 0.065223709, 0.066581895, 0.067945254, 0.069313947, 0.070688138, 0.072067999, 0.073453706, 0.074845439, 0.076243387, 0.077647741, 0.079058703, 0.080476478, 0.081901281, 0.083333333, 0.084772864, 0.086220111, 0.087675322, 0.089138753, 0.090610672, 0.092091355, 0.093581092, 0.095080184, 0.096588945, 0.098107703, 0.099636799, 0.101176593, 0.102727460, 0.104289792, 0.105864001, 0.107450521, 0.109049805, 0.110662333, 0.112288609, 0.113929166, 0.115584564, 0.117255399, 0.118942300, 0.120645935, 0.122367013, 0.124106289, 0.125864567, 0.127642706, 0.129441625, 0.131262308, 0.133105811, 0.134973272, 0.136865918, 0.138785075, 0.140732180, 0.142708798, 0.144716630, 0.146757540, 0.148833573, 0.150946979, 0.153100246, 0.155296137, 0.157537732, 0.159828486, 0.162172290, 0.164573556, 0.167037321, 0.169569377, 0.172176437, 0.174866360, 0.177648438, 0.180533797, 0.183535940, 0.186671533, 0.189961540, 0.193432959, 0.197121574, 0.201076558, 0.205368745, 0.210106912, 0.215474286, 0.221828352, 0.230092657};
//double t[128] = {0.001243411, 0.002486897, 0.003730536, 0.004974402, 0.006218572, 0.007463123, 0.008708130, 0.009953671, 0.011199823, 0.012446663, 0.013694269, 0.014942719, 0.016192092, 0.017442468, 0.018693925, 0.019946544, 0.021200406, 0.022455594, 0.023712190, 0.024970276, 0.026229938, 0.027491260, 0.028754328, 0.030019230, 0.031286054, 0.032554890, 0.033825827, 0.035098959, 0.036374377, 0.037652178, 0.038932457, 0.040215312, 0.041500842, 0.042789149, 0.044080336, 0.045374508, 0.046671771, 0.047972235, 0.049276012, 0.050583214, 0.051893957, 0.053208361, 0.054526547, 0.055848638, 0.057174762, 0.058505049, 0.059839632, 0.061178647, 0.062522235, 0.063870540, 0.065223709, 0.066581895, 0.067945254, 0.069313947, 0.070688138, 0.072067999, 0.073453706, 0.074845439, 0.076243387, 0.077647741, 0.079058703, 0.080476478, 0.081901281, 0.083333333, 0.084772864, 0.086220111, 0.087675322, 0.089138753, 0.090610672, 0.092091355, 0.093581092, 0.095080184, 0.096588945, 0.098107703, 0.099636799, 0.101176593, 0.102727460, 0.104289792, 0.105864001, 0.107450521, 0.109049805, 0.110662333, 0.112288609, 0.113929166, 0.115584564, 0.117255399, 0.118942300, 0.120645935, 0.122367013, 0.124106289, 0.125864567, 0.127642706, 0.129441625, 0.131262308, 0.133105811, 0.134973272, 0.136865918, 0.138785075, 0.140732180, 0.142708798, 0.144716630, 0.146757540, 0.148833573, 0.150946979, 0.153100246, 0.155296137, 0.157537732, 0.159828486, 0.162172290, 0.164573556, 0.167037321, 0.169569377, 0.172176437, 0.174866360, 0.177648438, 0.180533797, 0.183535940, 0.186671533, 0.189961540, 0.193432959, 0.197121574, 0.201076558, 0.205368745, 0.210106912, 0.215474286, 0.221828352, 0.230092657, 0.250000000};
double t[128] = { 0.0012434106, 0.0012434865, 0.0012436384, 0.0012438663, 0.0012441703, 0.0012445506, 0.0012450075, 0.0012455412, 0.0012461519, 0.0012468400, 0.0012476060, 0.0012484501, 0.0012493730, 0.0012503751, 0.0012514570, 0.0012526193, 0.0012538626, 0.0012551877, 0.0012565954, 0.0012580864, 0.0012596616, 0.0012613220, 0.0012630685, 0.0012649022, 0.0012668241, 0.0012688354, 0.0012709375, 0.0012731314, 0.0012754187, 0.0012778006, 0.0012802789, 0.0012828549, 0.0012855304, 0.0012883071, 0.0012911869, 0.0012941717, 0.0012972634, 0.0013004642, 0.0013037763, 0.0013072020, 0.0013107437, 0.0013144041, 0.0013181857, 0.0013220913, 0.0013261240, 0.0013302866, 0.0013345826, 0.0013390153, 0.0013435881, 0.0013483049, 0.0013531695, 0.0013581861, 0.0013633589, 0.0013686924, 0.0013741915, 0.0013798612, 0.0013857066, 0.0013917334, 0.0013979473, 0.0014043546, 0.0014109617, 0.0014177754, 0.0014248029, 0.0014320520, 0.0014395306, 0.0014472472, 0.0014552110, 0.0014634314, 0.0014719186, 0.0014806833, 0.0014897370, 0.0014990919, 0.0015087608, 0.0015187575, 0.0015290967, 0.0015397942, 0.0015508666, 0.0015623319, 0.0015742093, 0.0015865194, 0.0015992844, 0.0016125281, 0.0016262762, 0.0016405563, 0.0016553984, 0.0016708349, 0.0016869010, 0.0017036348, 0.0017210780, 0.0017392760, 0.0017582783, 0.0017781393, 0.0017989188, 0.0018206825, 0.0018435031, 0.0018674611, 0.0018926458, 0.0019191569, 0.0019471057, 0.0019766172, 0.0020078324, 0.0020409104, 0.0020760326, 0.0021134056, 0.0021532671, 0.0021958910, 0.0022415958, 0.0022907538, 0.0023438037, 0.0024012662, 0.0024637652, 0.0025320555, 0.0026070602, 0.0026899226, 0.0027820783, 0.0028853587, 0.0030021437, 0.0031355927, 0.0032900065, 0.0034714193, 0.0036886151, 0.0039549842, 0.0042921867, 0.0047381675, 0.0053673734, 0.0063540660, 0.0082643055, 0.0199073428 };
dac_channel_t current_channel;
double current_freq;
int16_t i;
int16_t current_amp;
uint64_t next_alarm_value;
extern int max_amp;
void IRAM_ATTR timer_update_dac(void *arg) {
    //printf("interupted!\n");
    //dac_output_voltage(current_channel, current_amp);
    dac_output_voltage(current_channel, current_amp);
    timer_group_clr_intr_status_in_isr(TIMER_GROUP_0, TIMER_0);
    /*
    current_amp++;
    if (current_amp >= 256) {
        current_amp = 0;
    }
    */
    
    if (i >= 0 && i < 128) {
        //next_alarm_value = round(t[i + 1] - t[i] / current_freq / 0.000000025);
        next_alarm_value = round(t[i] / current_freq / time_per_tick);
        current_amp++;
        if (current_amp > max_amp) {
            max_amp = current_amp;
        }

        
        if (current_amp > 255) {
            current_amp = 255;
        }
        
    } else if (i >= 128 && i < 256) {
        //next_alarm_value = round(t[128 - i + 1] - t[128 - i] / current_freq / 0.000000025);
        next_alarm_value = round(t[255 - i] / current_freq / time_per_tick); //127 - (i - 128) = 255 - i
        current_amp--;
    } else if (i >= 256 && i < 256 + 128) {
        //next_alarm_value = round(t[256 - i + 1] - t[256 - i] / current_freq / 0.000000025);
        next_alarm_value = round(t[i - 256] / current_freq / time_per_tick); //i - 256
        current_amp--;
        if (current_amp < 0) {
            current_amp = 0;
        }
    } else if (i >= 256 + 128 && i < 512) {
        //next_alarm_value = round(t[512 - i + 1] - t[512 - i] / current_freq / 0.000000025);
        next_alarm_value = round(t[511 - i] / current_freq / time_per_tick); // 127 - (i - 256 - 128) = 511 - i
        current_amp++;
    }

    i++;
    if (i >= 512) {
        i = 0;
    }
    
    
    /*
    if (current_amp != 0) {
        current_amp = 0;
        next_alarm_value = 8000;
    } else {
        current_amp = 128;
        next_alarm_value = 2000;
    }
    */
    //next_alarm_value = abs(t[current_amp] - t[current_amp - 1]);
    //next_alarm_value = current_amp * 10;
    //timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, next_alarm_value);
    timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, next_alarm_value);
    timer_group_enable_alarm_in_isr(TIMER_GROUP_0, TIMER_0);
}

//支持相位调节的延时器版本
//相位从负到正，------- 2表示2*pi,1表示pi,0.5表示1/2*pi,0表示0*pi ------- 最终被转化为0至2*pi
//相位的单位为弧度
esp_err_t sin_wave_start(dac_channel_t channel, double freq, double phase) {
    ESP_RETURN_ON_FALSE(channel < DAC_CHANNEL_MAX, ESP_ERR_INVALID_ARG, TAG, "DAC channel error");
    max_amp = 0;
    current_channel = channel;
    current_freq = freq;
    
    dac_output_enable(current_channel);
    /*
    dac_output_voltage(current_channel, 112);
    esp_rom_delay_us(1000 * 100);
    dac_output_voltage(current_channel, 10);
    esp_rom_delay_us(1000 * 10);
    */
    //phase = phase % (2.0 * pi);
    phase = fmod(phase, 2.0 * pi);
    printf("phase is : %09f\n", phase);
    //将负相位转化为正相位
    if (phase < 0.0) {
        phase += 2.0 * pi;
    }
    printf("positive phase is : %09f\n", phase);
    double v = sin(phase);
    printf("v is : %09f\n", v);//v范围为-1,1
    v = v * 128.0 + 128.0;//转化到0至256.0区间
    i = floor(v);
    if (i >= 256) {
        current_amp = 255;
    } else {
        current_amp = i;
    }
    printf("current_amp is : %d\n", i);
    if (phase >= 0.0 && phase < 0.5 * pi) {
        i = i - 128;
    } else if (phase >= 0.5 * pi && phase < pi) {
        i = 256 - i + 128;
    } else if (phase >= pi && phase < 1.5 * pi) {
        i = 128 - i + 256;
    } else if (phase >= 1.5 * pi && phase < 2.0 * pi) {
        i = 512 - (128 - i);
    }
    printf("i is : %d\n", i);
    timer_config_t timer_config = {
        .divider = 2,//2分频，APB时钟为80Mhz，2分频后周期为25ns
        .counter_dir = TIMER_COUNT_UP,//向上计数
        .counter_en = TIMER_PAUSE,//等待手动开启
        .alarm_en = TIMER_ALARM_EN,//计数到达终点报警中断
        .auto_reload = TIMER_AUTORELOAD_EN,//自动重装重新计时
        .intr_type = TIMER_INTR_LEVEL,//电平中断
    };
    
    //next_alarm_value = 0;
    next_alarm_value = 40 * 1000 * 5;//5ms延时后输出第一个数据
    //current_amp = 128;
    esp_err_t result;
    result = timer_init(TIMER_GROUP_0, TIMER_0, &timer_config);
    if (result == ESP_OK) {
        //printf("timer_init ok!\n");
    } else {
        printf("timer_init failed!!!\n");
    }
    result = timer_set_counter_value(TIMER_GROUP_0, TIMER_0, 0x00000000ULL);
    if (result == ESP_OK) {
        //printf("timer_set_counter_value ok!\n");
    } else {
        printf("timer_set_counter_value failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_set_counter_value failed!!!\n");
    }
    result = timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, next_alarm_value);
    if (result == ESP_OK) {
        //printf("timer_set_alarm_value ok!\n");
    } else {
        printf("timer_set_alarm_value failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_set_alarm_value failed!!!\n");
    }
    result = timer_enable_intr(TIMER_GROUP_0, TIMER_0);
    if (result == ESP_OK) {
        //printf("timer_enable_intr ok!\n");
    } else {
        printf("timer_enable_intr failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_enable_intr failed!!!\n");
    }
    //result = timer_isr_register(TIMER_GROUP_0, TIMER_0, &timer_update_dac, NULL, ESP_INTR_FLAG_SHARED, NULL);
    result = timer_isr_register(TIMER_GROUP_0, TIMER_0, &timer_update_dac, NULL, ESP_INTR_FLAG_IRAM, NULL);
    if (result == ESP_OK) {
        //printf("timer_isr_register ok!\n");
    } else {
        printf("timer_isr_register failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_isr_register failed!!!\n");
    }
    result = timer_start(TIMER_GROUP_0, TIMER_0);
    if (result == ESP_OK) {
        printf("timer_start ok!\n");
    } else {
        printf("timer_start failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_start failed!!!\n");
    }
    return ESP_OK;
}

//不完美的软件延时版本

esp_err_t sin_wave(dac_channel_t channel, double freq) {
    int t1[256];
    ESP_RETURN_ON_FALSE(channel < DAC_CHANNEL_MAX, ESP_ERR_INVALID_ARG, TAG, "DAC channel error");
    for (int i = 0; i < 256; i++) {
        double t2 = t[i] / freq;
        t1[i] = round(t2 * 1000000); //精确到us
    }
    dac_output_enable(channel);
    while (true) {
        for (int i = 0; i < 255; i++) {
            dac_output_voltage(channel, i);
            esp_rom_delay_us(t1[i + 1] - t1[i]);
        }
    
        for (int i = 255; i > 0; i--) {
            dac_output_voltage(channel, i);
            esp_rom_delay_us(t1[i] - t1[i - 1]);
        }
    }
    

    return ESP_OK;
}
