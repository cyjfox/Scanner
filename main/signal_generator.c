#include "signal_generator.h"
#include "esp_check.h"
#include "driver/dac_common.h"
#include "math.h"
//#include "esp_rom_sys.h"
#include "driver/timer.h"
#include "driver/gpio.h"

static const char *TAG = "signal generator";
double g_offset;
uint32_t phase_count = 0;

//uint32_t counter_total = 60000000;
//累加器给为12万相位
uint32_t counter_total = 120000;
uint8_t err_code = 0;
double aaa;
uint16_t bbb;
//typedef uint8_t (*)(int16_t index) DataGenerarotor;

//uint8_t ecgAmplitudeTable[1000] = {279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 280, 280, 280, 280, 282, 284, 288, 290, 291, 291, 293, 295, 297, 299, 300, 302, 302, 306, 306, 308, 310, 311, 313, 315, 317, 319, 320, 322, 324, 326, 328, 331, 331, 335, 335, 339, 339, 342, 344, 346, 350, 350, 353, 353, 357, 359, 360, 364, 364, 368, 370, 371, 375, 375, 379, 380, 382, 386, 386, 390, 390, 393, 395, 397, 399, 400, 402, 404, 404, 408, 408, 408, 411, 411, 411, 411, 411, 411, 411, 411, 411, 408, 408, 406, 404, 400, 399, 397, 393, 390, 386, 382, 379, 375, 371, 368, 362, 357, 353, 350, 342, 339, 333, 328, 324, 317, 313, 306, 302, 295, 290, 288, 284, 280, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 277, 275, 273, 271, 268, 262, 259, 255, 251, 246, 240, 237, 233, 230, 226, 222, 219, 213, 208, 204, 200, 197, 193, 190, 186, 180, 175, 171, 168, 164, 160, 157, 153, 148, 142, 139, 135, 131, 128, 133, 139, 144, 153, 164, 173, 184, 195, 206, 215, 226, 237, 248, 257, 268, 279, 288, 299, 310, 320, 330, 340, 351, 362, 371, 382, 393, 404, 413, 424, 435, 444, 455, 466, 477, 486, 497, 508, 517, 528, 539, 550, 559, 570, 580, 591, 600, 611, 622, 633, 642, 653, 664, 673, 684, 695, 706, 715, 726, 737, 748, 757, 768, 779, 790, 799, 810, 820, 830, 840, 851, 862, 871, 882, 893, 902, 913, 924, 935, 944, 955, 966, 977, 986, 991, 997, 999, 993, 990, 980, 971, 962, 953, 944, 935, 926, 917, 910, 899, 891, 880, 873, 862, 855, 844, 837, 826, 819, 808, 800, 790, 782, 771, 764, 753, 746, 735, 728, 717, 710, 699, 691, 680, 673, 662, 655, 644, 637, 626, 619, 608, 600, 590, 582, 571, 564, 553, 546, 535, 528, 517, 510, 499, 491, 480, 473, 462, 455, 444, 437, 426, 419, 408, 400, 390, 382, 371, 364, 353, 346, 335, 328, 319, 310, 300, 291, 282, 273, 264, 255, 246, 237, 228, 219, 210, 200, 191, 182, 173, 164, 155, 146, 137, 128, 119, 110, 100, 91, 82, 73, 64, 55, 46, 37, 28, 19, 10, 4, 0, 4, 8, 19, 26, 33, 40, 50, 59, 66, 73, 80, 88, 97, 106, 113, 120, 128, 135, 144, 153, 160, 168, 175, 182, 191, 200, 208, 215, 222, 230, 239, 248, 259, 262, 266, 270, 273, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 280, 282, 284, 284, 291, 293, 295, 299, 300, 302, 306, 310, 311, 315, 317, 320, 322, 326, 328, 331, 333, 337, 339, 342, 344, 348, 350, 353, 355, 359, 360, 364, 366, 370, 371, 375, 377, 380, 382, 386, 388, 391, 393, 397, 399, 400, 404, 406, 410, 411, 415, 417, 419, 422, 424, 428, 430, 433, 435, 437, 440, 442, 444, 448, 450, 451, 455, 457, 459, 462, 464, 466, 470, 470, 473, 477, 477, 480, 482, 484, 488, 488, 491, 491, 495, 497, 499, 500, 502, 504, 506, 506, 510, 510, 511, 513, 513, 515, 517, 517, 517, 520, 520, 520, 520, 522, 522, 522, 522, 522, 522, 522, 520, 520, 520, 520, 517, 517, 515, 513, 510, 508, 506, 502, 499, 497, 493, 488, 484, 480, 477, 471, 466, 462, 455, 450, 444, 437, 431, 424, 419, 411, 404, 397, 390, 382, 375, 368, 360, 350, 342, 335, 328, 319, 311, 302, 295, 291, 288, 284, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279, 279}; 

//uint8_t (*g_pAmplitudeTable)[1000];

double ecgAmplitudeTable[1000] = {0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.28051001821, 0.28051001821, 0.28051001821, 0.28051001821, 0.28233151184, 0.28415300546, 0.28779599271, 0.28961748634, 0.29143897996, 0.29143897996, 0.29326047359, 0.29508196721, 0.29690346084, 0.29872495446, 0.30054644809, 0.30236794171, 0.30236794171, 0.30601092896, 0.30601092896, 0.30783242259, 0.30965391621, 0.31147540984, 0.31329690346, 0.31511839709, 0.31693989071, 0.31876138434, 0.32058287796, 0.32240437158, 0.32422586521, 0.32604735883, 0.32786885246, 0.33151183971, 0.33151183971, 0.33515482696, 0.33515482696, 0.33879781421, 0.33879781421, 0.34244080146, 0.34426229508, 0.34608378871, 0.34972677596, 0.34972677596, 0.35336976321, 0.35336976321, 0.35701275046, 0.35883424408, 0.36065573770, 0.36429872495, 0.36429872495, 0.36794171220, 0.36976320583, 0.37158469945, 0.37522768670, 0.37522768670, 0.37887067395, 0.38069216758, 0.38251366120, 0.38615664845, 0.38615664845, 0.38979963570, 0.38979963570, 0.39344262295, 0.39526411658, 0.39708561020, 0.39890710383, 0.40072859745, 0.40255009107, 0.40437158470, 0.40437158470, 0.40801457195, 0.40801457195, 0.40801457195, 0.41165755920, 0.41165755920, 0.41165755920, 0.41165755920, 0.41165755920, 0.41165755920, 0.41165755920, 0.41165755920, 0.41165755920, 0.40801457195, 0.40801457195, 0.40619307832, 0.40437158470, 0.40072859745, 0.39890710383, 0.39708561020, 0.39344262295, 0.38979963570, 0.38615664845, 0.38251366120, 0.37887067395, 0.37522768670, 0.37158469945, 0.36794171220, 0.36247723133, 0.35701275046, 0.35336976321, 0.34972677596, 0.34244080146, 0.33879781421, 0.33333333333, 0.32786885246, 0.32422586521, 0.31693989071, 0.31329690346, 0.30601092896, 0.30236794171, 0.29508196721, 0.28961748634, 0.28779599271, 0.28415300546, 0.28051001821, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27686703097, 0.27504553734, 0.27322404372, 0.27140255009, 0.26775956284, 0.26229508197, 0.25865209472, 0.25500910747, 0.25136612022, 0.24590163934, 0.24043715847, 0.23679417122, 0.23315118397, 0.22950819672, 0.22586520947, 0.22222222222, 0.21857923497, 0.21311475410, 0.20765027322, 0.20400728597, 0.20036429872, 0.19672131148, 0.19307832423, 0.18943533698, 0.18579234973, 0.18032786885, 0.17486338798, 0.17122040073, 0.16757741348, 0.16393442623, 0.16029143898, 0.15664845173, 0.15300546448, 0.14754098361, 0.14207650273, 0.13843351548, 0.13479052823, 0.13114754098, 0.12750455373, 0.13296903461, 0.13843351548, 0.14389799636, 0.15300546448, 0.16393442623, 0.17304189435, 0.18397085610, 0.19489981785, 0.20582877960, 0.21493624772, 0.22586520947, 0.23679417122, 0.24772313297, 0.25683060109, 0.26775956284, 0.27868852459, 0.28779599271, 0.29872495446, 0.30965391621, 0.32058287796, 0.32969034608, 0.34061930783, 0.35154826958, 0.36247723133, 0.37158469945, 0.38251366120, 0.39344262295, 0.40437158470, 0.41347905282, 0.42440801457, 0.43533697632, 0.44444444444, 0.45537340619, 0.46630236794, 0.47723132969, 0.48633879781, 0.49726775956, 0.50819672131, 0.51730418944, 0.52823315118, 0.53916211293, 0.55009107468, 0.55919854281, 0.57012750455, 0.58105646630, 0.59198542805, 0.60109289617, 0.61202185792, 0.62295081967, 0.63387978142, 0.64298724954, 0.65391621129, 0.66484517304, 0.67395264117, 0.68488160291, 0.69581056466, 0.70673952641, 0.71584699454, 0.72677595628, 0.73770491803, 0.74863387978, 0.75774134791, 0.76867030965, 0.77959927140, 0.79052823315, 0.79963570128, 0.81056466302, 0.82149362477, 0.83060109290, 0.84153005464, 0.85245901639, 0.86338797814, 0.87249544627, 0.88342440801, 0.89435336976, 0.90346083789, 0.91438979964, 0.92531876138, 0.93624772313, 0.94535519126, 0.95628415301, 0.96721311475, 0.97814207650, 0.98724954463, 0.99271402550, 0.99817850638, 1.00000000000, 0.99453551913, 0.99089253188, 0.98178506375, 0.97267759563, 0.96357012750, 0.95446265938, 0.94535519126, 0.93624772313, 0.92714025501, 0.91803278689, 0.91074681239, 0.89981785064, 0.89253187614, 0.88160291439, 0.87431693989, 0.86338797814, 0.85610200364, 0.84517304189, 0.83788706740, 0.82695810565, 0.81967213115, 0.80874316940, 0.80145719490, 0.79052823315, 0.78324225865, 0.77231329690, 0.76502732240, 0.75409836066, 0.74681238616, 0.73588342441, 0.72859744991, 0.71766848816, 0.71038251366, 0.69945355191, 0.69216757741, 0.68123861566, 0.67395264117, 0.66302367942, 0.65573770492, 0.64480874317, 0.63752276867, 0.62659380692, 0.61930783242, 0.60837887067, 0.60109289617, 0.59016393443, 0.58287795993, 0.57194899818, 0.56466302368, 0.55373406193, 0.54644808743, 0.53551912568, 0.52823315118, 0.51730418944, 0.51001821494, 0.49908925319, 0.49180327869, 0.48087431694, 0.47358834244, 0.46265938069, 0.45537340619, 0.44444444444, 0.43715846995, 0.42622950820, 0.41894353370, 0.40801457195, 0.40072859745, 0.38979963570, 0.38251366120, 0.37158469945, 0.36429872495, 0.35336976321, 0.34608378871, 0.33515482696, 0.32786885246, 0.31876138434, 0.30965391621, 0.30054644809, 0.29143897996, 0.28233151184, 0.27322404372, 0.26411657559, 0.25500910747, 0.24590163934, 0.23679417122, 0.22768670310, 0.21857923497, 0.20947176685, 0.20036429872, 0.19125683060, 0.18214936248, 0.17304189435, 0.16393442623, 0.15482695811, 0.14571948998, 0.13661202186, 0.12750455373, 0.11839708561, 0.10928961749, 0.10018214936, 0.09107468124, 0.08196721311, 0.07285974499, 0.06375227687, 0.05464480874, 0.04553734062, 0.03642987250, 0.02732240437, 0.01821493625, 0.00910746812, 0.00364298725, 0.00000000000, 0.00364298725, 0.00728597450, 0.01821493625, 0.02550091075, 0.03278688525, 0.04007285974, 0.04918032787, 0.05828779599, 0.06557377049, 0.07285974499, 0.08014571949, 0.08743169399, 0.09653916211, 0.10564663024, 0.11293260474, 0.12021857923, 0.12750455373, 0.13479052823, 0.14389799636, 0.15300546448, 0.16029143898, 0.16757741348, 0.17486338798, 0.18214936248, 0.19125683060, 0.20036429872, 0.20765027322, 0.21493624772, 0.22222222222, 0.22950819672, 0.23861566485, 0.24772313297, 0.25865209472, 0.26229508197, 0.26593806922, 0.26958105647, 0.27322404372, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.28051001821, 0.28233151184, 0.28415300546, 0.28415300546, 0.29143897996, 0.29326047359, 0.29508196721, 0.29872495446, 0.30054644809, 0.30236794171, 0.30601092896, 0.30965391621, 0.31147540984, 0.31511839709, 0.31693989071, 0.32058287796, 0.32240437158, 0.32604735883, 0.32786885246, 0.33151183971, 0.33333333333, 0.33697632058, 0.33879781421, 0.34244080146, 0.34426229508, 0.34790528233, 0.34972677596, 0.35336976321, 0.35519125683, 0.35883424408, 0.36065573770, 0.36429872495, 0.36612021858, 0.36976320583, 0.37158469945, 0.37522768670, 0.37704918033, 0.38069216758, 0.38251366120, 0.38615664845, 0.38797814208, 0.39162112933, 0.39344262295, 0.39708561020, 0.39890710383, 0.40072859745, 0.40437158470, 0.40619307832, 0.40983606557, 0.41165755920, 0.41530054645, 0.41712204007, 0.41894353370, 0.42258652095, 0.42440801457, 0.42805100182, 0.42987249545, 0.43351548270, 0.43533697632, 0.43715846995, 0.44080145719, 0.44262295082, 0.44444444444, 0.44808743169, 0.44990892532, 0.45173041894, 0.45537340619, 0.45719489982, 0.45901639344, 0.46265938069, 0.46448087432, 0.46630236794, 0.46994535519, 0.46994535519, 0.47358834244, 0.47723132969, 0.47723132969, 0.48087431694, 0.48269581056, 0.48451730419, 0.48816029144, 0.48816029144, 0.49180327869, 0.49180327869, 0.49544626594, 0.49726775956, 0.49908925319, 0.50091074681, 0.50273224044, 0.50455373406, 0.50637522769, 0.50637522769, 0.51001821494, 0.51001821494, 0.51183970856, 0.51366120219, 0.51366120219, 0.51548269581, 0.51730418944, 0.51730418944, 0.51730418944, 0.52094717668, 0.52094717668, 0.52094717668, 0.52094717668, 0.52276867031, 0.52276867031, 0.52276867031, 0.52276867031, 0.52276867031, 0.52276867031, 0.52276867031, 0.52094717668, 0.52094717668, 0.52094717668, 0.52094717668, 0.51730418944, 0.51730418944, 0.51548269581, 0.51366120219, 0.51001821494, 0.50819672131, 0.50637522769, 0.50273224044, 0.49908925319, 0.49726775956, 0.49362477231, 0.48816029144, 0.48451730419, 0.48087431694, 0.47723132969, 0.47176684882, 0.46630236794, 0.46265938069, 0.45537340619, 0.44990892532, 0.44444444444, 0.43715846995, 0.43169398907, 0.42440801457, 0.41894353370, 0.41165755920, 0.40437158470, 0.39708561020, 0.38979963570, 0.38251366120, 0.37522768670, 0.36794171220, 0.36065573770, 0.34972677596, 0.34244080146, 0.33515482696, 0.32786885246, 0.31876138434, 0.31147540984, 0.30236794171, 0.29508196721, 0.29143897996, 0.28779599271, 0.28415300546, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459, 0.27868852459};
double (*g_pAmplitudeTable)[1000] = NULL;
uint32_t g_k;
dac_channel_t current_channel;
/*
uint8_t ECGSignalGenerator(int16_t index) {
    index = index %
}
*/


uint8_t current_amp;
uint64_t next_alarm_value;
//double[1000] * const pSignal;
//DataGeneratrotor pDataGenerator;
uint16_t i;
double freq;
double amp;
double g_phase;


double dds_counter_update(uint32_t k) {
    phase_count += k;
    phase_count = phase_count % counter_total;
    //累加器60000000，定时器1M的版本
    //uint16_t phase_now = ceil(phase_count / 60000);
    //累加器12万，定时器2k的版本
    uint16_t phase_now = ceil(phase_count / 120);
    if (phase_now >= 1000) {
        err_code = 77;
        bbb = phase_now;
        phase_now = 999;
    } else {
        err_code = 66;
        bbb = phase_now;
    }
    return (*g_pAmplitudeTable)[phase_now];
    //return (*g_pAmplitudeTable)[999];
    //return 0.5;
}

uint8_t update_amplitude() {
    double ampTblVal = dds_counter_update(g_k);
    aaa = ampTblVal;
    //return 188;
    double finalAmp = g_offset + amp * ampTblVal;
    

    uint16_t a = 0;
    
    if (finalAmp < 0) {
        a = 0;
    } else if (finalAmp > 1.0) {
        a = 255;
    } else {
        a = 255 * finalAmp;
    }
    
    if (a < 0 || a > 255) {
        err_code = 90;
        aaa = ampTblVal;
        a = 255;
    }

    return a; 
    
}

uint8_t level = 0;
void IRAM_ATTR timer_update_dac(void *arg) {
    //printf("interupted!\n");
    //dac_output_voltage(current_channel, current_amp);
    /*
    dac_output_voltage(current_channel, current_amp);
    timer_group_clr_intr_status_in_isr(TIMER_GROUP_0, TIMER_0);
    
    current_amp = update_amplitude();
    timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, next_alarm_value);
    timer_group_enable_alarm_in_isr(TIMER_GROUP_0, TIMER_0);
    */
    level = ~level;
    gpio_set_level(GPIO_NUM_23, level);
    timer_group_clr_intr_status_in_isr(TIMER_GROUP_0, TIMER_0);
    
    timer_group_enable_alarm_in_isr(TIMER_GROUP_0, TIMER_0);
    /*
    if (current_amp == 0) {
        current_amp = 127;
    } else {
        current_amp = 0;
    }
    */
    //current_amp += 1;
    /*
    if (i >= 0 && i < 128) {
        //next_alarm_value = round(t[i + 1] - t[i] / current_freq / 0.000000025);
        next_alarm_value = round(t[i] / current_freq / time_per_tick);
        current_amp++;
        if (current_amp > max_amp) {
            max_amp = current_amp;
        }

        
        if (current_amp > 255) {
            current_amp = 255;
        }
        
    } else if (i >= 128 && i < 256) {
        //next_alarm_value = round(t[128 - i + 1] - t[128 - i] / current_freq / 0.000000025);
        next_alarm_value = round(t[255 - i] / current_freq / time_per_tick); //127 - (i - 128) = 255 - i
        current_amp--;
    } else if (i >= 256 && i < 256 + 128) {
        //next_alarm_value = round(t[256 - i + 1] - t[256 - i] / current_freq / 0.000000025);
        next_alarm_value = round(t[i - 256] / current_freq / time_per_tick); //i - 256
        current_amp--;
        if (current_amp < 0) {
            current_amp = 0;
        }
    } else if (i >= 256 + 128 && i < 512) {
        //next_alarm_value = round(t[512 - i + 1] - t[512 - i] / current_freq / 0.000000025);
        next_alarm_value = round(t[511 - i] / current_freq / time_per_tick); // 127 - (i - 256 - 128) = 511 - i
        current_amp++;
    }

    i++;
    i = i % 512;
    */
    
    //printf("current_amp : %d\n", current_amp);
}

esp_err_t signal_start(dac_channel_t channel, uint32_t delay_ms, double phase, double offset, double amplitude, double frequency, double (*pSignal)[1000])
{
    //esp_err_t signal_start(dac_channel_t channel, uint32_t delay_ms, double phase, double offset, double amplitude, double frequency, DataGenerarotor pPDataGenrator);

    gpio_config_t gpio_cfg = {};
    gpio_cfg.intr_type = GPIO_INTR_DISABLE,
    gpio_cfg.mode = GPIO_MODE_OUTPUT,
    gpio_cfg.pin_bit_mask = 1ULL << 23,
    gpio_cfg.pull_down_en = GPIO_PULLDOWN_DISABLE,
    gpio_cfg.pull_up_en = GPIO_PULLUP_ENABLE,
    
    gpio_config(&gpio_cfg);

    ESP_RETURN_ON_FALSE(channel < DAC_CHANNEL_MAX, ESP_ERR_INVALID_ARG, TAG, "DAC channel error");
    current_channel = channel;
    dac_output_enable(current_channel);
    
    //pDataGenrator = pPDataGenerator;
    g_pAmplitudeTable = pSignal;
    g_phase = phase;
    freq = frequency;
    g_k = freq / 0.01666;
    //g_k = 960;
    printf("g_k(count per minite) is : %d\n", g_k);
    amp = amplitude;
    g_offset = offset;
    //g_k = 70;
    phase_count = 0;
    //TODO
    //通过phase计算启动相位，从而得出i的初始值和current_amp的初始值
    i = 0;
    
    timer_config_t timer_config = {
        //.divider = 2,//2分频，APB时钟为80Mhz，2分频后周期为25ns
        .divider = 80,//80分频，频率为1m
        .counter_dir = TIMER_COUNT_UP,//向上计数
        .counter_en = TIMER_PAUSE,//等待手动开启
        .alarm_en = TIMER_ALARM_EN,//计数到达终点报警中断
        .auto_reload = TIMER_AUTORELOAD_EN,//自动重装重新计时
        .intr_type = TIMER_INTR_LEVEL,//电平中断
    };
    
    //next_alarm_value = 0;
    //uint64_t first_alarm_value = delay_ms * 0.001 / time_per_tick;//5ms延时后输出第一个数据
    //next_alarm_value = delay_ms * 0.001 / time_per_tick;//5ms延时后输出第一个数据
    next_alarm_value = delay_ms * 1000;
    printf("next_alarm_value to start the timer is : %d\n", (int)next_alarm_value);
    //current_amp = 128;
    esp_err_t result;
    result = timer_init(TIMER_GROUP_0, TIMER_0, &timer_config);
    if (result == ESP_OK) {
        //printf("timer_init ok!\n");
    } else {
        printf("timer_init failed!!!\n");
    }
    result = timer_set_counter_value(TIMER_GROUP_0, TIMER_0, 0x00000000ULL);
    if (result == ESP_OK) {
        //printf("timer_set_counter_value ok!\n");
    } else {
        printf("timer_set_counter_value failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_set_counter_value failed!!!\n");
    }
    //result = timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, first_alarm_value);
    //result = timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, next_alarm_value);
    result = timer_set_alarm_value(TIMER_GROUP_0, TIMER_0, 1);
    if (result == ESP_OK) {
        //printf("timer_set_alarm_value ok!\n");
    } else {
        printf("timer_set_alarm_value failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_set_alarm_value failed!!!\n");
    }
    //next_alarm_value = 40;//基准时钟设置为1MHz
    //next_alarm_value = 1;
    next_alarm_value = 500;//500us计时一次，频率为2k
    //400000时为10ms
    current_amp = update_amplitude();
    printf("first current_amp : %d\n", current_amp);
    result = timer_enable_intr(TIMER_GROUP_0, TIMER_0);
    if (result == ESP_OK) {
        //printf("timer_enable_intr ok!\n");
    } else {
        printf("timer_enable_intr failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_enable_intr failed!!!\n");
    }
    //result = timer_isr_register(TIMER_GROUP_0, TIMER_0, &timer_update_dac, NULL, ESP_INTR_FLAG_SHARED, NULL);
    result = timer_isr_register(TIMER_GROUP_0, TIMER_0, &timer_update_dac, NULL, ESP_INTR_FLAG_IRAM, NULL);
    if (result == ESP_OK) {
        //printf("timer_isr_register ok!\n");
    } else {
        printf("timer_isr_register failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_isr_register failed!!!\n");
    }
    result = timer_start(TIMER_GROUP_0, TIMER_0);
    if (result == ESP_OK) {
        printf("timer_start ok!\n");
    } else {
        printf("timer_start failed!!!\n");
        ESP_RETURN_ON_ERROR(result, TAG, "timer_start failed!!!\n");
    }
    return ESP_OK;
}

esp_err_t signal_stop(dac_channel_t channel)
{
    ESP_RETURN_ON_FALSE(channel < DAC_CHANNEL_MAX, ESP_ERR_INVALID_ARG, TAG, "DAC channel error");
    dac_output_disable(channel);
    return timer_pause(TIMER_GROUP_0, TIMER_0);
}